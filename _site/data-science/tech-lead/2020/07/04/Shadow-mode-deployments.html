<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Shadow mode deployments: somewhere between “on” and “off” | Neal Lathia</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Shadow mode deployments: somewhere between “on” and “off”" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is one of the most useful tools that I know of to quickly ship systems that make important decisions with high uncertainty." />
<meta property="og:description" content="This is one of the most useful tools that I know of to quickly ship systems that make important decisions with high uncertainty." />
<link rel="canonical" href="http://0.0.0.0:4000/data-science/tech-lead/2020/07/04/Shadow-mode-deployments.html" />
<meta property="og:url" content="http://0.0.0.0:4000/data-science/tech-lead/2020/07/04/Shadow-mode-deployments.html" />
<meta property="og:site_name" content="Neal Lathia" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-04T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"This is one of the most useful tools that I know of to quickly ship systems that make important decisions with high uncertainty.","headline":"Shadow mode deployments: somewhere between “on” and “off”","dateModified":"2020-07-04T00:00:00-05:00","datePublished":"2020-07-04T00:00:00-05:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/data-science/tech-lead/2020/07/04/Shadow-mode-deployments.html"},"url":"http://0.0.0.0:4000/data-science/tech-lead/2020/07/04/Shadow-mode-deployments.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/feed.xml" title="Neal Lathia" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Shadow mode deployments: somewhere between “on” and “off” | Neal Lathia</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Shadow mode deployments: somewhere between “on” and “off”" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This is one of the most useful tools that I know of to quickly ship systems that make important decisions with high uncertainty." />
<meta property="og:description" content="This is one of the most useful tools that I know of to quickly ship systems that make important decisions with high uncertainty." />
<link rel="canonical" href="http://0.0.0.0:4000/data-science/tech-lead/2020/07/04/Shadow-mode-deployments.html" />
<meta property="og:url" content="http://0.0.0.0:4000/data-science/tech-lead/2020/07/04/Shadow-mode-deployments.html" />
<meta property="og:site_name" content="Neal Lathia" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-07-04T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"This is one of the most useful tools that I know of to quickly ship systems that make important decisions with high uncertainty.","headline":"Shadow mode deployments: somewhere between “on” and “off”","dateModified":"2020-07-04T00:00:00-05:00","datePublished":"2020-07-04T00:00:00-05:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/data-science/tech-lead/2020/07/04/Shadow-mode-deployments.html"},"url":"http://0.0.0.0:4000/data-science/tech-lead/2020/07/04/Shadow-mode-deployments.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/feed.xml" title="Neal Lathia" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Neal Lathia</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/research/">Research</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Shadow mode deployments: somewhere between &quot;on&quot; and &quot;off&quot;</h1><p class="page-description">This is one of the most useful tools that I know of to quickly ship systems that make important decisions with high uncertainty.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-07-04T00:00:00-05:00" itemprop="datePublished">
        Jul 4, 2020
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#data-science">data-science</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#tech-lead">tech-lead</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Shipping changes to a system that makes a complex decision is rife with uncertainty. You may be adding a rule to a rule engine that already has 10s of rules, you may be changing a machine learning model that eats up 10s of features and spits out a probability, or (more likely) you may be doing a combination of both.</p>

<p>The reason this is often difficult is because the most pressing question that comes up is no longer just “will it work?” (as in, will the system make <strong>a</strong> decision?) but, rather, “will it work well?” (i.e., will the system make <strong>a good</strong> decision?).</p>

<p>I’ve seen these types of cases lead to a lot of worry and <em>analysis paralysis</em>: teams do not ship because they are worried that their system will make <em>bad</em> decisions, and instead opt to try and map out ‘what if’ scenarios on paper or reconstruct a lot of possible scenarios using historical data.</p>

<p>To get around this, I’m a vocal proponent of shipping systems in one of three states: off, on, and shadow mode. Shadow mode, specifically, is the best tool I’ve found to answer the ‘how good <em>could</em> this system be?’ question. So, what are these three states?</p>

<h3 id="-off">❌ Off</h3>

<p>A system that is “off” doesn’t do anything <em>except for</em> integrate well into the rest of the system. If called, it doesn’t execute anything and returns a default value without breaking.</p>

<p>It seems odd to think about shipping code that doesn’t do anything. As Stephen’s post on <a href="https://highgrowthengineering.substack.com/p/writing-maintainable-code-at-speed">High Growth Engineering</a> explains, this is a useful way to define interfaces between different systems and enable each subsystem to be iterated on separately.</p>

<p>I’ve seen this approach used most often when wanting to ship a feature that impacts many teams and one team (or group of stakeholders) isn’t ready. Instead of waiting for them, ship it and turn it off for them! Having the ability to quickly flip the switch and turn things off is also a life saver if you are dealing with an incident.</p>

<h3 id="-on">✅ On</h3>

<p>Systems that are “on” are just that: when called, they do some work, they log some data, and they return a value.</p>

<p>It is common to add conditions here that quantify <em>how</em> on some systems are. This could be for two reasons:</p>

<ol>
  <li><strong>Staged roll out</strong>: you may be unsure of the performance of a system, so you just turn it on for a small fraction of traffic (e.g., 5%). As nothing blows up, you continue to turn up the dial until you reach 100% and the system is generally available for all your customers.</li>
  <li><strong>Experiment</strong>: you may want to compare two variants of a system, and so you redirect a percentage of traffic down one decision path, and the remainder goes down another. This is different from a staged roll out because it ends with the winning variant being turned on for everyone.</li>
</ol>

<p>Both of these typically manifest in the same way–using flags of some sort in the code–but have very different intents and outcomes (safely scale up vs. compare and decide). One of my bugbears is when teams call something “an experiment,” when it’s actually a staged roll out (but I will leave that rant for another day).</p>

<h3 id="️-shadow-mode">⚠️ Shadow mode</h3>

<p>Finally, systems that are in “shadow mode” are somewhere in between: when called, they do some work, they log data about all of their decisions, and then return a default value <em>as if</em> they were off. All of the work is done, but the decision is not acted on.</p>

<p>You end up with is a boat load of data that you can use to pragmatically answer the question: <em>what if this system had been on?</em> (because, technically, it was on!) without requiring Data Scientists to try and reverse engineer answers to this out of historical data. Shadow mode balances between insight (you get all of the data) and risk (you don’t need to act on the outcomes); critically, it tests your system’s performance on real, recent examples.</p>

<p>Last year, we were shipping some text classifiers. We had trained them using historical data that had been manually tagged (and we knew the tags were <em>sometimes</em> unreliable); we were unsure of how well classifiers trained on old data would perform on more recent conversations. Given that these classifiers were powering a system that sent automated answers to customers, we were not willing to turn them on without some reassurances that they would work well.</p>

<p>We had a couple of options: (1) wait and collect new data, and then manually evaluate the classifiers using it, or (2) ship the classifiers <em>in shadow mode</em>.</p>

<p>We did the latter; we shipped a system that would query the classifiers for their decision, log the result, and then <em>carry on as if it never had</em>. In this case, the automated answer was not sent to customers <em>even when</em> when the classifiers said that one should be sent. Instead, for a sample of these decisions, the system created validation tasks which would appear in our internal tooling. We used them to manually evaluate those decisions. The result? Within days, we had precision and recall values for the classifiers–based on the live data from production. This enabled us to make quicker decisions: to either confidently turn them on, or know that we needed to do more work and retrain the models.</p>

<h3 id="-how-does-this-compare-to-ab-tests">💭 How does this compare to A/B tests?</h3>

<p>The one bit that you may be thinking about is how <em>shadow mode</em> compares to A/B testing. There are <em>different</em> problems that shadow mode deployments enable solving: shadow mode allows you to know whether a system inherently works before you go ahead and experiment with whether it impacts a business metric.</p>

<p>For the text classifier example, above, we wanted to be sure that the system worked well (it gave precise answers) <em>before</em> testing whether it impacted customer behaviour as we hoped it would (sending automated support answers would encourage self-service).</p>

<p>There are other scenarios where regulatory guidance may impede running A/B tests (I imagine this is the case with credit scoring models), or where you have low-volume/high-impact traffic (as is the case in fraud monitoring) where you may not <em>want</em> to send a percentage of traffic down a path that you don’t know anything about.</p>

<p>I’m writing this post as it has become one of the most recurrent things that I’ve talked about with Engineers when we are shipping systems that make a decision. Many times, those decisions are powered by a machine learning model; but the principle applies equally if you remove machine learning from the equation.</p>


  </div><a class="u-url" href="/data-science/tech-lead/2020/07/04/Shadow-mode-deployments.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/nlathia" title="nlathia"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/neal_lathia" title="neal_lathia"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
