<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Testing SQL the hard way | Neal Lathia</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Testing SQL the hard way" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Looking at the minutiae of discovering when analytics SQL is completely broken (the hard way)." />
<meta property="og:description" content="Looking at the minutiae of discovering when analytics SQL is completely broken (the hard way)." />
<link rel="canonical" href="http://0.0.0.0:4000/data-science/monzo/2020/03/15/Testing-SQL-the-hard-way.html" />
<meta property="og:url" content="http://0.0.0.0:4000/data-science/monzo/2020/03/15/Testing-SQL-the-hard-way.html" />
<meta property="og:site_name" content="Neal Lathia" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-15T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Looking at the minutiae of discovering when analytics SQL is completely broken (the hard way).","headline":"Testing SQL the hard way","dateModified":"2020-03-15T00:00:00-05:00","datePublished":"2020-03-15T00:00:00-05:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/data-science/monzo/2020/03/15/Testing-SQL-the-hard-way.html"},"url":"http://0.0.0.0:4000/data-science/monzo/2020/03/15/Testing-SQL-the-hard-way.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/feed.xml" title="Neal Lathia" /><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Testing SQL the hard way | Neal Lathia</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Testing SQL the hard way" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Looking at the minutiae of discovering when analytics SQL is completely broken (the hard way)." />
<meta property="og:description" content="Looking at the minutiae of discovering when analytics SQL is completely broken (the hard way)." />
<link rel="canonical" href="http://0.0.0.0:4000/data-science/monzo/2020/03/15/Testing-SQL-the-hard-way.html" />
<meta property="og:url" content="http://0.0.0.0:4000/data-science/monzo/2020/03/15/Testing-SQL-the-hard-way.html" />
<meta property="og:site_name" content="Neal Lathia" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-15T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Looking at the minutiae of discovering when analytics SQL is completely broken (the hard way).","headline":"Testing SQL the hard way","dateModified":"2020-03-15T00:00:00-05:00","datePublished":"2020-03-15T00:00:00-05:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/data-science/monzo/2020/03/15/Testing-SQL-the-hard-way.html"},"url":"http://0.0.0.0:4000/data-science/monzo/2020/03/15/Testing-SQL-the-hard-way.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/feed.xml" title="Neal Lathia" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head><body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Neal Lathia</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About Me</a><a class="page-link" href="/research/">Research</a><a class="page-link" href="/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Testing SQL the hard way</h1><p class="page-description">Looking at the minutiae of discovering when analytics SQL is completely broken (the hard way).</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-03-15T00:00:00-05:00" itemprop="datePublished">
        Mar 15, 2020
      </time>
       ‚Ä¢ <span class="read-time" title="Estimated read time">
    
    
      9 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/categories/#data-science">data-science</a>
        &nbsp;
      
        <a class="category-tags-link" href="/categories/#monzo">monzo</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h3 id="-context">üìä Context</h3>
<p>It‚Äôs not uncommon for Data Science workflows to have large chunks of SQL. Maybe you have a sequence of queries that you run every day to produce dashboards, or maybe you have a bunch of queries that spit out features that you feed into machine learning algorithms. If you‚Äôre a Data Scientist, you‚Äôre bound to have written a <code class="highlighter-rouge">SELECT</code> statement at <em>some point</em> of your day!</p>

<p>There‚Äôs an online wiki for programming languages called <a href="http://progopedia.com/">progopedia</a> which <a href="http://progopedia.com/language/sql/">lists SQL</a> as ‚Äú<strong>not</strong> a programming language:‚Äù this perfectly characterises everything that is strange about these words that we write, execute, and rely on to get our insights right every single day. SQL doesn‚Äôt have all the sensible things that <em>real</em> programming languages have to help us feel confident that they are doing what we think they‚Äôre doing. Primarily, it lacks a straightforward abstraction for ‚Äúunit‚Äù testing.</p>

<p>About a year and half ago, a colleague <a href="https://uk.linkedin.com/in/jackcook909">Jack</a> and I were wrangling with a query that <em>had to be right</em>‚Äìwe are, after all, working in a regulated industry. We were dealing with a bunch of queries that were orchestrated together with <a href="https://airflow.apache.org/">Airflow</a>.  The main problem we had was that we could not rely on the input to our query being right <strong>and</strong> needed to prevent this query from quietly succeeding if anything in its results was wrong.</p>

<p>We went the entire journey from manually validating entries in our table to automating the detection and reporting of inconsistencies so that we could flag or fix errors that were upstream of our query: this post is a heavily simplified example of what we did. In case you‚Äôre wondering, I‚Äôve called the post ‚Äútesting SQL the hard way‚Äù because we have now abandoned this approach (and replaced it with <a href="https://www.getdbt.com/">dbt</a>). But it had some fun lessons, so here goes!</p>

<h3 id="Ô∏è-a-table-of-users">üëØ‚Äç‚ôÇÔ∏è A table of users</h3>
<p>Let‚Äôs look at a toy example: let‚Äôs say that we want to make a table that has some key information about all of a company‚Äôs customers. I‚Äôve written all of the snippets below in BigQuery SQL, so that you can copy/paste it into the <a href="https://console.cloud.google.com/bigquery">console</a> and play around with it yourself.</p>

<p>We start by building up some mock data. Imagine you have a JSON payload (an ‚Äúevent‚Äù) each time a user creates an account, with the <code class="highlighter-rouge">user_id</code>, the timestamp of when the account was created, and a bunch of other critical fields. Something like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="n">account_created_events</span> <span class="k">AS</span> <span class="p">(</span>
 <span class="k">SELECT</span> <span class="o">*</span>
 <span class="k">FROM</span> <span class="k">UNNEST</span><span class="p">([</span>
  <span class="nv">"{</span><span class="se">\"</span><span class="nv">user_id</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">user_1</span><span class="se">\"</span><span class="nv">, </span><span class="se">\"</span><span class="nv">account_created</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">2020-01-01</span><span class="se">\"</span><span class="nv">}"</span><span class="p">,</span>
  <span class="nv">"{</span><span class="se">\"</span><span class="nv">user_id</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">user_2</span><span class="se">\"</span><span class="nv">, </span><span class="se">\"</span><span class="nv">account_created</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">2020-01-02</span><span class="se">\"</span><span class="nv">}"</span><span class="p">,</span>
  <span class="nv">"{</span><span class="se">\"</span><span class="nv">user_id</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">user_3</span><span class="se">\"</span><span class="nv">, </span><span class="se">\"</span><span class="nv">account_created</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">2020-01-03</span><span class="se">\"</span><span class="nv">}"</span><span class="p">,</span>
  <span class="nv">"{</span><span class="se">\"</span><span class="nv">user_id</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">user_4</span><span class="se">\"</span><span class="nv">, </span><span class="se">\"</span><span class="nv">account_created</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">2020-01-04</span><span class="se">\"</span><span class="nv">}"</span>
  <span class="p">])</span> <span class="k">AS</span> <span class="n">event</span>
<span class="p">),</span>
</code></pre></div></div>

<p>When users finish some set of actions, we get another event to tell us that the user has completed their signup. Here‚Äôs some more mock data, for those same users:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">signup_completed_events</span> <span class="k">AS</span> <span class="p">(</span>
 <span class="k">SELECT</span> <span class="o">*</span>
 <span class="k">FROM</span> <span class="k">UNNEST</span><span class="p">([</span>
  <span class="nv">"{</span><span class="se">\"</span><span class="nv">user_id</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">user_1</span><span class="se">\"</span><span class="nv">, </span><span class="se">\"</span><span class="nv">signup_completed</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">2020-01-02</span><span class="se">\"</span><span class="nv">}"</span><span class="p">,</span>
  <span class="nv">"{</span><span class="se">\"</span><span class="nv">user_id</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">user_2</span><span class="se">\"</span><span class="nv">, </span><span class="se">\"</span><span class="nv">signup_completed</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">2020-01-03</span><span class="se">\"</span><span class="nv">}"</span><span class="p">,</span>
  <span class="nv">"{</span><span class="se">\"</span><span class="nv">user_id</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">user_3</span><span class="se">\"</span><span class="nv">, </span><span class="se">\"</span><span class="nv">signup_completed</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">2020-01-04</span><span class="se">\"</span><span class="nv">}"</span><span class="p">,</span>
  <span class="nv">"{</span><span class="se">\"</span><span class="nv">user_id</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">user_4</span><span class="se">\"</span><span class="nv">, </span><span class="se">\"</span><span class="nv">signup_completed</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">2020-01-05</span><span class="se">\"</span><span class="nv">}"</span>
  <span class="p">])</span> <span class="k">AS</span> <span class="n">event</span>
<span class="p">),</span>
</code></pre></div></div>

<p>We can take those two events and create a table with one row per user:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- Extract the account creation columns</span>
<span class="k">WITH</span> <span class="n">accounts_created</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> 
  <span class="n">JSON_EXTRACT_SCALAR</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="nv">"$.user_id"</span><span class="p">)</span> <span class="k">AS</span> <span class="n">user_id</span><span class="p">,</span>
  <span class="nb">TIMESTAMP</span><span class="p">(</span><span class="n">JSON_EXTRACT_SCALAR</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="nv">"$.account_created"</span><span class="p">))</span> <span class="k">AS</span> <span class="n">account_created</span>

  <span class="k">FROM</span> <span class="n">account_created_events</span>
<span class="p">),</span>

<span class="c1">-- Extract the signup completion columns</span>
<span class="n">signups_completed</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span> 
  <span class="n">JSON_EXTRACT_SCALAR</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="nv">"$.user_id"</span><span class="p">)</span> <span class="k">AS</span> <span class="n">user_id</span><span class="p">,</span>
  <span class="nb">TIMESTAMP</span><span class="p">(</span><span class="n">JSON_EXTRACT_SCALAR</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="nv">"$.signup_completed"</span><span class="p">))</span> <span class="k">AS</span> <span class="n">signup_completed</span>

  <span class="k">FROM</span> <span class="n">signup_completed_events</span>
<span class="p">)</span>

<span class="c1">-- Join them together</span>
<span class="k">SELECT</span>
<span class="n">user_id</span><span class="p">,</span>
<span class="n">account_created</span><span class="p">,</span>
<span class="n">signup_completed</span><span class="p">,</span>
<span class="n">TIMESTAMP_DIFF</span><span class="p">(</span><span class="n">signup_completed</span><span class="p">,</span> <span class="n">account_created</span><span class="p">,</span> <span class="n">HOUR</span><span class="p">)</span> <span class="k">AS</span> <span class="n">signup_time</span>

<span class="k">FROM</span> <span class="n">accounts_created</span>
<span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">signups_completed</span> <span class="k">USING</span> <span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</code></pre></div></div>

<p>And here are the results:</p>

<p><img src="https://nlathia.github.io/blog/images/bigquery-post/users-table.png" alt="" title="A table of users" /></p>

<p>Perfect! This is the ideal analytics table to answer a ton of different basic analytic questions: How many users do we have? How many of them signed up today? How long does it take users, on average, to complete signup?</p>

<p>This is also the type of table that could be extended with tens (or even hundreds) of columns, each representing unique pieces of information about each user. It is the type of canonical data table that could grow to having tens of contributors and many tens of use cases. As long as this table maintains its core structural assumption (one row per user), we‚Äôll be good to go.</p>

<p>How could this go wrong?</p>

<h3 id="-someone-completes-the-signup-flow-twice">üôÉ Someone completes the signup flow twice</h3>

<p>Let‚Äôs imagine that a customer, due to whatever reason, completes the signup flow twice. Maybe there‚Äôs a bug in the app and the customer uninstalls &amp; reinstalls the app, maybe there was a bug or failure in the backend service that is emitting those events (whatever, it doesn‚Äôt matter!).</p>

<p>Nothing has changed in the analytics code base, but now we have two signup completed events for that user:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">signup_completed_events</span> <span class="k">AS</span> <span class="p">(</span>
 <span class="k">SELECT</span> <span class="o">*</span>
 <span class="k">FROM</span> <span class="k">UNNEST</span><span class="p">([</span>
  <span class="nv">"{</span><span class="se">\"</span><span class="nv">user_id</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">user_1</span><span class="se">\"</span><span class="nv">, </span><span class="se">\"</span><span class="nv">signup_completed</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">2020-01-02</span><span class="se">\"</span><span class="nv">}"</span><span class="p">,</span>
  <span class="nv">"{</span><span class="se">\"</span><span class="nv">user_id</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">user_2</span><span class="se">\"</span><span class="nv">, </span><span class="se">\"</span><span class="nv">signup_completed</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">2020-01-03</span><span class="se">\"</span><span class="nv">}"</span><span class="p">,</span>
  <span class="nv">"{</span><span class="se">\"</span><span class="nv">user_id</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">user_3</span><span class="se">\"</span><span class="nv">, </span><span class="se">\"</span><span class="nv">signup_completed</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">2020-01-04</span><span class="se">\"</span><span class="nv">}"</span><span class="p">,</span>
  <span class="nv">"{</span><span class="se">\"</span><span class="nv">user_id</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">user_4</span><span class="se">\"</span><span class="nv">, </span><span class="se">\"</span><span class="nv">signup_completed</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">2020-01-05</span><span class="se">\"</span><span class="nv">}"</span><span class="p">,</span>
  <span class="nv">"{</span><span class="se">\"</span><span class="nv">user_id</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">user_3</span><span class="se">\"</span><span class="nv">, </span><span class="se">\"</span><span class="nv">signup_completed</span><span class="se">\"</span><span class="nv">: </span><span class="se">\"</span><span class="nv">2020-02-04</span><span class="se">\"</span><span class="nv">}"</span> <span class="c1">-- Yikes!</span>
  <span class="p">])</span> <span class="k">AS</span> <span class="n">event</span>
<span class="p">),</span>
</code></pre></div></div>

<p>This tiniest of errors ‚Äì something that is largely invisible to the person who is <em>writing</em> the SQL, breaks the table: <code class="highlighter-rouge">user_3</code> appears twice. Not only that, but your stats on signup completion rates have shot through the roof!</p>

<p><img src="https://nlathia.github.io/blog/images/bigquery-post/users-table-errors.png" alt="" title="A table of users with errors!" /></p>

<p>Herein lies the problem: a tiny issue in the data has propagated itself through the <code class="highlighter-rouge">LEFT JOIN</code>s in the analytics code base, and has completely skewed some metrics that you are using.</p>

<p>Of course, you could argue that this is <em>fairly trivial</em> to fix: we‚Äôd need to add in a pre-processing step on the signup completed events to pick the one we care about more, and spit out one signup event per user. But what if this table has tens or hundreds of columns? What if the person contributing a new column is not the person who added the signup stats column, so doesn‚Äôt know this? What if we have <em>two</em> of these types of problems manifest at the same time? What if this table is input to some downstream queries, and all they know is that <em>their</em> table is now wrong?</p>

<p>These problems are more of a headache to discover and diagnose than they are to fix. Indeed, they may first manifest as a question about the <em>metrics</em> (‚Äúwhy has our average sign up time gone through the roof?‚Äù) and not about the <em>data</em>.</p>

<h3 id="-unit-testing-a-table-in-two-steps">üêõ ‚ÄúUnit‚Äù testing a table in two steps</h3>

<p>This post is not about fixing those bugs: it is only about an approach that we used to use to <em>detect</em> these types of problems with some sort of meaningful error message. At its core, this method relies on <strong>enumerating your assumptions</strong> about the structure of the table, and then <strong>triggering an error in the query execution</strong> if you find any.</p>

<p>In our example, our key assumption was that the table has <strong>one row per user</strong>.</p>

<p><strong>Step 1</strong>. Separately from the query above, we wrote a query that should create an empty <code class="highlighter-rouge">users_table_errors</code> table if the <code class="highlighter-rouge">users</code> table‚Äôs assumptions were not broken:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="n">user_validation</span> <span class="k">AS</span> <span class="p">(</span>
  <span class="k">SELECT</span>
  <span class="n">user_id</span><span class="p">,</span>
  <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num_rows</span>

  <span class="k">FROM</span> <span class="n">users</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span>
  <span class="k">HAVING</span> <span class="n">num_rows</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="c1">-- Should never be the case, amirite?</span>
<span class="p">)</span>

<span class="k">SELECT</span>
<span class="nv">"Duplicated user_ids"</span> <span class="k">AS</span> <span class="n">failure_type</span><span class="p">,</span>
<span class="k">COUNT</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">user_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num_failures</span>

<span class="k">FROM</span> <span class="n">user_validation</span>

<span class="c1">-- Union all with any other validations (e.g. validating time stamps)</span>
</code></pre></div></div>

<p>These types of queries are an extremely useful way of (a) documenting what you expect, and (b) creating a table of all of the (in this case) user ids that don‚Äôt match your expectations ‚Äì and how many times each one is duplicated.</p>

<p><img src="https://nlathia.github.io/blog/images/bigquery-post/users-validation-table.png" alt="" title="A validation table with a list of errors." /></p>

<p><strong>Step 2</strong>. Now that we have a way to identify errors, we need a way to stop our query from completing successfully if any errors are found. The first way we did this was to force BigQuery to compute something it couldn‚Äôt if it found errors: we would literally encode a one divided by zero. Shortly after, we found a debugging function buried in <a href="(https://cloud.google.com/bigquery/docs/reference/standard-sql/debugging_functions)">the BigQuery documentation</a>.</p>

<p>If a validations table is <em>not</em> empty, we used this <code class="highlighter-rouge">ERROR()</code> function to stop the query! It looks like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
<span class="n">ERROR</span><span class="p">(</span><span class="n">CONCAT</span><span class="p">(</span><span class="nv">"ERROR: "</span><span class="p">,</span> <span class="n">num_failures</span><span class="p">,</span> <span class="nv">" "</span><span class="p">,</span> <span class="n">failure_type</span><span class="p">))</span> <span class="k">AS</span> <span class="n">error</span>

<span class="k">FROM</span> <span class="n">users_table_errors</span>
<span class="k">WHERE</span> <span class="n">num_failures</span> <span class="o">!=</span> <span class="mi">0</span>
</code></pre></div></div>

<p>If you run this in the BigQuery console, it pops up with this kind of alert:</p>

<p><img src="https://nlathia.github.io/blog/images/bigquery-post/bigquery-error.png" alt="" title="The BigQuery ERROR() alert." /></p>

<p>The final workflow would run (1) the original query, (2) the validation query, and then (3) the error query. This approach really accelerated our ability to diagnose and fix errors; it de-coupled the <del>code</del> SQL that did the work from the SQL that did the validation, and it automatically documented all of our assumptions about a given table.</p>

<p>For our example, above: we‚Äôd see an error message that reads <code class="highlighter-rouge">ERROR: 1 Duplicated user_ids</code>; we‚Äôd pop open the <code class="highlighter-rouge">users_table_errors</code> and see that it has 1 entry with <code class="highlighter-rouge">user_3</code>; and voil√†, we‚Äôd already be on track to finding and resolving the problem.</p>

<h3 id="-why-is-this-the-hard-way-of-testing">üèö Why is this the ‚Äúhard way‚Äù of testing?</h3>

<p>We got a lot of value out of the approach above; the major trade-off was that we had to write (nearly) double the amount of SQL. This is not too dissimilar from what happens in other programming languages, where we <em>can</em> write unit tests.</p>

<p>However, these are definitely not <a href="https://en.wikipedia.org/wiki/Unit_testing"><strong>unit</strong> tests</a>: we would primarily discover errors in the data when the analytics pipeline was running, and had to make choices as to whether we wanted our (fairly huge) graph of queries to halt running completely on every error, or continue with warnings. We had started designing ways to quantify the severity of errors (both in terms of columns <em>and</em> in terms of number of affected rows), to run queries on samples of data, and more.</p>

<p>By the end of 2019, though, the Data Science team at Monzo migrated to using data build tool, or <a href="https://www.getdbt.com/">dbt</a>. If you want to read about why we think that was a good choice, <a href="https://stephen.sh/posts/why-is-dbt-so-important">Stephen‚Äôs post here</a> describes things that we like about it. It helped us to automate a lot of the work flow that I‚Äôve described above, and more.</p>

<p>Does this solve everything we need to ensure reliable, consistent, and scalable analytics queries? Absolutely not. The experience of writing this kind of ‚Äúcode‚Äù is still very much characterised by the ‚Äútry running it and see if the results look sensible,‚Äù which is a far cry from where it could be. But it‚Äôs a great step in the right direction.</p>


  </div><a class="u-url" href="/data-science/monzo/2020/03/15/Testing-SQL-the-hard-way.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/nlathia" title="nlathia"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/neal_lathia" title="neal_lathia"><svg class="svg-icon grey"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
